# 初识JVM
## 一 自动内存管理
### 1.1 JVM内存结构

- #### 程序计数器(Program Counter Register)

  作用：记住下一条JVM指令的执行地址

  特点：

  - 线程私有
  - 不会存在内存溢出

- #### 虚拟机栈（JVM Stacks）

  定义：

  - 每个线程运行是所需要的内存，程序虚拟机栈

  - 每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存

  - 每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法

  问题：

  1. 垃圾回收是否涉及栈内存？

     答：不需要，栈内存是由方法调用产生的栈帧内存，栈帧内存随着每一个方法调用结束而自动释放。

  2. 栈内存分配越大越好吗？（-Xss指定栈内存大小）

     答：栈内存越大，线程数越少，栈内存大小只会提升方法调用的个数（递归深度）。

  3. 方法内的局部变量是否线程安全？

     答：如果方法内局部变量没有逃离方法的作用范围，那么它是线程安全的，如果局部变量引用了对象（不是基本类型），并逃离了方法的作用范围，那么他就是线程不安全的。

  栈内存溢出：

  - 栈帧过多导致栈内存溢出（递归调用深度过深）
  - 栈帧过大导致栈内存溢出

  线程运行诊断：

  1. top  检测cpu占用过多的进程pid
  2. ps H -eo pid,tid,%cpu | grep [pid]  找到cpu占用过高的线程
  3. jstack [pid]  查看java虚拟机栈的线程
  4. 将第二步找到的tid转换为16进制，并找到对应的线程

- #### 本地方法栈（Native Method Stacks）

  native方法运行需要的内存空间

- #### 堆

  定义：存放通过new关键字创建的对象或数组

  特点：

  - 线程共享，堆中对象都需要考虑线程安全问题
  - 有垃圾回收机制

